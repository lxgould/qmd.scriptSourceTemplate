---
title: "Automated Script Execution Report"
format:
  email:
    toc: true
    toc_depth: 2
    toc-location: right
    anchor-sections: false
    css: report.css
email-preview: false
engine: knitr
resource_files:
- run_something.R
- make_data_file.R
---

```{r setup}
#| echo: FALSE

# Shiny app name & Connect URL extension
app_name <- "Shiny Scripting Template"
shinyExt <- "scriptingTemplate_app/"

#- Day of week & time when scripts are run (use "day" for daily-run scripts)
scriptDay  <- "day"
scriptTime <- "0700"

#- Relative paths: for: `scriptDir` = scripts to be run; 
#-                      `dataDir` = output data directory relative to shiny-data/

# scriptDir <- "R/getData/" # most apps have scripts in this directory
scriptDir <- ""
dataDir   <- "fakeDir"

#- List the scripts here that need to be run. 
runScripts <- c("make_data_file.R", "run_something.R")

#- GitHub repo URL:
ghURL <- glue::glue("https://github.com/SPG-Data-Systems/{repo}", repo = "")

#- ========== NOTHING BELOW THIS LINE NEEDS TO BE EDITED ==================

#- Make full Shiny App URL & absolute data directory path
connectURL   <- glue::glue("https://connect.spgenetics.com/{shinyExt}")
shinyDataDir <- glue::glue("/srv/shiny-server/shiny-data/{dataDir}")

#- Set script status default to "failure" and changes depending on the outcome
#- of the script execution.
script_list <- rep("failure", length(runScripts)) |>
  as.list() |> 
  stats::setNames(runScripts)

#- for keeping track of scripts and errors
success_count = 0
error_count = 0
error_scripts = c()


#- Set up a hook so R errors are highlighted
knitr::knit_hooks$set(error = function(x, options) { 
  paste(c('\n\n:::{style="color:Crimson; background-color: SeaShell;"}',
          gsub('^## Error', '**ERROR**', x),
          ':::'), collapse = '\n')
})

```

---
subtitle: "[`r app_name`](`r connectURL`)"
---


## About

This report shows the results of running scripts for the [`r app_name`](`r connectURL`) app.  
Code available on GitHub [`r fontawesome::fa("github")`](`r ghURL`)

### Schedule
These scripts are run every `r scriptDay` at `r scriptTime` Eastern.  

### Environment Parameters
This section shows parameter information from the operating system during the 
last script execution.


```{bash}
#| label: shell_info
#| echo: FALSE

ME=`basename $0 .sh`
CL="`basename $0` ${@}"
CWD=`pwd`
ME_START=`date +"%Y%m%d_%T"`

printf "\n%-20s:\n" "BEGIN PROGRAM" 
printf "%s\n" "-------------------------------------------"
printf "%-20s: %s\n" "Command Line" "${CL}"
printf "%-20s: %s\n" "Time" "$ME_START"
printf "%-20s: %s\n" "User" "$USER"
printf "%-20s: %s\n" "Home Dir." "$HOME"
printf "%-20s: %s\n" "Shell" "$SHELL"
printf "%-20s: %s\n" "PWD" "$CWD"
printf "%-20s: %s\n" "Host" `hostname -s | tr '[a-z]' '[A-Z]'`
printf "%-20s: %s\n" "LANG" "$LANG"
printf "%-20s: %s\n" "R Home" "$R_HOME"
printf "%s\n" '------------------------------------'
```




---

## R Scripts

```{r, echo=FALSE, include=TRUE, error=TRUE, results='asis'}

for (script in names(script_list)) {
  
  knitr::knit_child(
    text = c(
      glue::glue("### Script: \"{script}\""),
      '```{r, echo = F, results=\'markup\'}',
      'result <- tryCatch(
         { source(paste0(scriptDir, script), print.eval = TRUE) },
         error = function(e) { c("error", e) }
       )',
      '```'
    ), 
    quiet = T, envir = environment()
  ) |>
    cat(sep = '\n')

  
  if (result[1] == "error") {
    error_count = error_count + 1
    error_scripts = c(error_scripts, script)

    knitr::knit_child(
      quiet = T,
      text = as.character(
        htmltools::div( 
          class = "errMsg",
          htmltools::p( "***ERROR!*** ", result[2] )
        )
      )
    ) |>
      cat()
  } else {
    success_count = success_count + 1
    script_list[[script]] = "success"
  }
  
  cat("---", "\n")
}

```


```{r results='asis', echo = FALSE}
script_df <- t(as.data.frame(script_list))
names(script_df) <- c("script", "status")

if (error_count > 0 | success_count == 0) {
  statusSymbol <- fontawesome::fa("triangle-exclamation", fill = "#F4A71C", margin_right = '0.2em')
  statusMsg <- "ERRORS FOUND!"
  sendEmail <- T
} else {
  statusSymbol <- fontawesome::fa("circle-check", fill = "#63A945", prefer_type = "solid", margin_right = '0.2em')
  statusMsg <- "No errors found"
  sendEmail <- F
}
```

## `r statusSymbol` Status: _`r statusMsg`_ 



```{r}
#| echo: FALSE

knitr::kable(script_df)
```


<!-- Setup email to send on error -->

::: {.email}

::: {.email-scheduled}
`{r} sendEmail`
:::

::: {.subject}
ERROR: {{< meta title >}}
:::

The "`r app_name`" {{< meta title >}} encountered errors while running the following scripts:

```{r, include = F, echo = F}

errorList <- sapply(error_scripts, USE.NAMES = F, FUN = function(x){
  htmltools::tags$li(x) |>
    as.character()
}) |>
  c()

```

```{r, echo = F,  results='asis'}
cat(errorList)
htmltools::tags$br() |>
  as.character() |>
  cat("\n")
```

Visit the [hosted report]({{< env RSC_REPORT_URL >}})
for full details.

:::


